--[[
    KnHub CG | ESP Avançado (Box, Rainbow, Name, Skeleton, HPBar, Tracer, Distância, Arma/Item, Filtro por equipe)
    - Todas funções ESP individuais, ativação/toggle
    - HUB organizado com suporte à rolagem e movimentação (Drag & Drop)
    - Aimbot com checagem de paredes
    - Interface bem espaçada
    - Compatível Delta Executor, Synapse, KRNL, entre outros!
]]

local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

-- Funções utilitárias
local function clamp(n, lo, hi) return math.max(lo, math.min(hi, n)) end
local function IsEnemy(plr)
    if not plr.Team or not LocalPlayer.Team then return plr ~= LocalPlayer end
    return LocalPlayer.Team ~= plr.Team
end
local function safeFindHumanoidRootPart(ch)
    if ch and typeof(ch) == "Instance" then
        return ch:FindFirstChild("HumanoidRootPart")
    end
    return nil
end

-- Função raycast checagem de parede/obstáculo (linha de visão)
local function isVisible(from, to)
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {LocalPlayer.Character, Workspace.CurrentCamera}
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.IgnoreWater = true
    local ok, result = pcall(function()
        return Workspace:Raycast(from, (to - from).Unit * (to - from).Magnitude, params)
    end)
    if not ok or not result then
        return true -- nada no caminho ou raycast falhou
    end
    -- Ignora partes sem Collision ou CanQuery
    if not result.Instance or not result.Instance.CanCollide or not result.Instance.CanQuery then
        return true
    end
    return false
end

-- Interface HUB (rolagem + drag/móvel)
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = "KnHubCG"
gui.ResetOnSpawn = false
gui.Enabled = true

local mainFrame = Instance.new("Frame", gui)
mainFrame.Size = UDim2.new(0, 410, 0, 540)
mainFrame.Position = UDim2.new(0, 150, 0, 60)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 32)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = false -- para compatibilidade, implementaremos drag custom

-- Adicionar drag & drop ao painel principal
local dragging, dragInput, dragStart, startPos
local function updateDrag(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(
        startPos.X.Scale,
        startPos.X.Offset + delta.X,
        startPos.Y.Scale,
        startPos.Y.Offset + delta.Y
    )
end

mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        updateDrag(input)
    end
end)

local scrollFrame = Instance.new("ScrollingFrame", mainFrame)
scrollFrame.Size = UDim2.new(1,0,1,0)
scrollFrame.Position = UDim2.new(0,0,0,0)
scrollFrame.CanvasSize = UDim2.new(0,0,0,900)
scrollFrame.ScrollBarThickness = 10
scrollFrame.BackgroundTransparency = 1
scrollFrame.BorderSizePixel = 0
scrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
scrollFrame.CanvasPosition = Vector2.new(0,0)
scrollFrame.ZIndex = 1

local tLabel = Instance.new("TextLabel", scrollFrame)
tLabel.Size = UDim2.new(1, 0, 0, 42)
tLabel.Position = UDim2.new(0, 0, 0, 0)
tLabel.BackgroundColor3 = Color3.fromRGB(36, 36, 46)
tLabel.TextColor3 = Color3.new(1, 1, 1)
tLabel.Text = "KnHub CG | ESP Avançado"
tLabel.Font = Enum.Font.GothamSemibold
tLabel.TextScaled = true
tLabel.ZIndex = 5

-- Botão fechar/minimizar
local closeBtn = Instance.new("TextButton", scrollFrame)
closeBtn.Size = UDim2.new(0,32,0,32)
closeBtn.Position = UDim2.new(1,-40,0,6)
closeBtn.BackgroundColor3 = Color3.fromRGB(210,40,40)
closeBtn.Text = "X"
closeBtn.TextScaled = true
closeBtn.TextColor3 = Color3.new(1,1,1)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.ZIndex = 10
closeBtn.MouseButton1Click:Connect(function() gui:Destroy() end)

local sectionY = 52 -- controle do eixo Y das seções

local function createSection(height, labelText)
    local sec = Instance.new("Frame", scrollFrame)
    sec.Size = UDim2.new(1,-20,0,height)
    sec.Position = UDim2.new(0,10,0,sectionY)
    sec.BackgroundColor3 = Color3.fromRGB(32,36,48)
    sec.BorderSizePixel = 0
    local secT = Instance.new("TextLabel", sec)
    secT.Size = UDim2.new(1,0,0,28)
    secT.Position = UDim2.new(0,0,0,0)
    secT.BackgroundColor3 = sec.BackgroundColor3
    secT.TextColor3 = Color3.new(1,1,1)
    secT.Font = Enum.Font.GothamBold
    secT.TextScaled = true
    secT.Text = labelText
    sectionY = sectionY + height + 12
    return sec
end

--------------------------------------------------------------------------------------------
-- 1. AIMBOT
local aimSection = createSection(120, "Aimbot")
local function makeToggle(parent, txt, def, xoff, yoff)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0,90,0,28)
    btn.Position = UDim2.new(0,xoff or 10,0,yoff or 38)
    btn.BackgroundColor3 = def and Color3.fromRGB(73,180,90) or Color3.fromRGB(53,56,70)
    btn.Text = txt..": "..(def and "ON" or "OFF")
    btn.Font = Enum.Font.GothamBold
    btn.TextColor3 = Color3.new(1,1,1)
    btn.TextScaled = true
    local state = def
    btn.MouseButton1Click:Connect(function()
        state = not state
        btn.Text = txt..": "..(state and "ON" or "OFF")
        btn.BackgroundColor3 = state and Color3.fromRGB(73,180,90) or Color3.fromRGB(53,56,70)
    end)
    return function() return state end
end

local aimbotOn = makeToggle(aimSection, "Aimbot", false, 10, 38)
local aimEnemiesOnly = true
local aimModeBtn = Instance.new("TextButton", aimSection)
aimModeBtn.Size = UDim2.new(0,110,0,28)
aimModeBtn.Position = UDim2.new(0,108,0,38)
aimModeBtn.BackgroundColor3 = Color3.fromRGB(43,60,80)
aimModeBtn.Text = "Target: Inimigos"
aimModeBtn.Font = Enum.Font.Code
aimModeBtn.TextColor3 = Color3.new(1,1,1)
aimModeBtn.TextScaled = true
aimModeBtn.MouseButton1Click:Connect(function()
    aimEnemiesOnly = not aimEnemiesOnly
    aimModeBtn.Text = "Target: "..(aimEnemiesOnly and "Inimigos" or "Todos")
end)
local aimLockedPlayer = nil
local aimLockBtn = Instance.new("TextButton", aimSection)
aimLockBtn.Size = UDim2.new(0,83,0,28)
aimLockBtn.Position = UDim2.new(0,230,0,38)
aimLockBtn.BackgroundColor3 = Color3.fromRGB(33,110,220)
aimLockBtn.Text = "Travar Mira"
aimLockBtn.TextScaled = true
aimLockBtn.TextColor3 = Color3.new(1,1,1)
aimLockBtn.Font = Enum.Font.GothamBold
local aimUnlockBtn = Instance.new("TextButton", aimSection)
aimUnlockBtn.Size = UDim2.new(0,83,0,28)
aimUnlockBtn.Position = UDim2.new(0,230,0,74)
aimUnlockBtn.BackgroundColor3 = Color3.fromRGB(180,50,43)
aimUnlockBtn.Text = "Destravar"
aimUnlockBtn.TextScaled = true
aimUnlockBtn.TextColor3 = Color3.new(1,1,1)
aimUnlockBtn.Font = Enum.Font.GothamBold
aimUnlockBtn.Visible = false
aimLockBtn.MouseButton1Click:Connect(function()
    local cam = workspace.CurrentCamera
    local center = Vector2.new(cam.ViewportSize.X/2, cam.ViewportSize.Y/2)
    local closest, closestDist = nil, 1e9
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr == LocalPlayer then continue end
        if aimEnemiesOnly and not IsEnemy(plr) then continue end
        local char = plr.Character
        if not char then continue end
        local hrp = safeFindHumanoidRootPart(char)
        if not hrp then continue end
        local vec, onScreen = cam:WorldToViewportPoint(hrp.Position)
        if not onScreen then continue end
        if not isVisible(cam.CFrame.Position, hrp.Position) then continue end
        local dist = (Vector2.new(vec.X,vec.Y)-center).Magnitude
        if dist < closestDist then closest, closestDist = plr, dist end
    end
    if closest then
        aimLockedPlayer = closest
        aimLockBtn.BackgroundColor3 = Color3.fromRGB(40,200,100)
        aimLockBtn.Text = "Mirando: "..closest.Name
        aimUnlockBtn.Visible = true
    end
end)
aimUnlockBtn.MouseButton1Click:Connect(function()
    aimLockedPlayer = nil
    aimLockBtn.BackgroundColor3 = Color3.fromRGB(33,110,220)
    aimLockBtn.Text = "Travar Mira"
    aimUnlockBtn.Visible = false
end)
local pullBox = Instance.new("TextBox", aimSection)
pullBox.Size = UDim2.new(0,80,0,28)
pullBox.Position = UDim2.new(0,10,0,74)
pullBox.Text = "Pull: 50"
pullBox.BackgroundColor3 = Color3.fromRGB(32,50,60)
pullBox.Font = Enum.Font.Code
pullBox.TextColor3 = Color3.new(1,1,1)
local pull = 50
pullBox.FocusLost:Connect(function()
    local n = tonumber(pullBox.Text:match("%d+")) or 50
    pull = clamp(n, 0, 100)
    pullBox.Text = "Pull: "..pull
end)
local fovBox = Instance.new("TextBox", aimSection)
fovBox.Size = UDim2.new(0,80,0,28)
fovBox.Position = UDim2.new(0,102,0,74)
fovBox.Text = "FOV: 100"
fovBox.BackgroundColor3 = Color3.fromRGB(30,58,82)
fovBox.Font = Enum.Font.Code
fovBox.TextColor3 = Color3.new(1,1,1)
local aimFOV = 100
fovBox.FocusLost:Connect(function()
    local n = tonumber(fovBox.Text:match("%d+")) or 100
    aimFOV = clamp(n,20,400)
    fovBox.Text = "FOV: "..aimFOV
end)

--------------------------------------------------------------------------------------------
-- 2. ESP AVANÇADO (TODAS FUNÇÕES SEPARADAS)
local espSection = createSection(302, "ESP Avançado")

-- Box ESP
local boxEspToggle = makeToggle(espSection, "Box ESP", false, 10, 38)
-- Rainbow ESP (box/skeleton/name)
local rainbowEspToggle = makeToggle(espSection, "ESP Rainbow", false, 108, 38)
-- Name ESP
local nameEspToggle = makeToggle(espSection, "ESP Name", false, 206, 38)
-- Skeleton ESP
local skeletonEspToggle = makeToggle(espSection, "Skeleton ESP", false, 304, 38)
-- HPBar Display
local hpEspToggle = makeToggle(espSection, "HPBar", false, 10, 78)
-- Tracer
local tracerEspToggle = makeToggle(espSection, "Tracer", false, 108, 78)
-- Distância
local distEspToggle = makeToggle(espSection, "Distância", false, 206, 78)
-- Arma/item
local weaponEspToggle = makeToggle(espSection, "Arma/Item", false, 304, 78)

-- Equipe/filtro
local espModeBtn = Instance.new("TextButton", espSection)
espModeBtn.Size = UDim2.new(0,170,0,28)
espModeBtn.Position = UDim2.new(0,120,0,128)
espModeBtn.BackgroundColor3 = Color3.fromRGB(73,120,190)
espModeBtn.Text = "Mostrar: Inimigos"
espModeBtn.Font = Enum.Font.Code
espModeBtn.TextColor3 = Color3.new(1,1,1)
espModeBtn.TextScaled = true
local espEnemiesOnly = true
espModeBtn.MouseButton1Click:Connect(function()
    espEnemiesOnly = not espEnemiesOnly
    espModeBtn.Text = "Mostrar: "..(espEnemiesOnly and "Inimigos" or "Todos")
end)

--------------------------------------------------------------------------------------------
-- 3. ESP por Jogador (autocomplete clicável)
local espPlayerSection = createSection(83, "ESP por Jogador (Autocomplete)")
local espPlayerActiveToggle = makeToggle(espPlayerSection, "Ativar", false, 10, 38)
local espPlayerBox = Instance.new("TextBox", espPlayerSection)
espPlayerBox.Size = UDim2.new(0,160,0,28)
espPlayerBox.Position = UDim2.new(0,104,0,38)
espPlayerBox.Text = ""
espPlayerBox.BackgroundColor3 = Color3.fromRGB(42,60,100)
espPlayerBox.Font = Enum.Font.GothamBold
espPlayerBox.TextColor3 = Color3.new(1,1,1)
espPlayerBox.PlaceholderText = "Nome do jogador..."

local suggestFrame = Instance.new("Frame", espPlayerSection)
suggestFrame.Visible = false
suggestFrame.BackgroundTransparency = 0.6
suggestFrame.Position = UDim2.new(0,104,0,68)
suggestFrame.Size = UDim2.new(0,160,0,62)
suggestFrame.BackgroundColor3 = Color3.fromRGB(32,42,80)
local suggestList = {}
for i=1,5 do
    local lbl = Instance.new("TextButton", suggestFrame)
    lbl.Size = UDim2.new(1,0,0,11)
    lbl.Position = UDim2.new(0,0,0,(i-1)*12)
    lbl.BackgroundTransparency = 1
    lbl.Font = Enum.Font.Code
    lbl.TextColor3 = Color3.new(0.9,0.9,1)
    lbl.TextScaled = true
    lbl.Visible = false
    table.insert(suggestList, lbl)
end

local espSelectedName = nil
local function updateSuggestions(txt)
    local names = {}
    local query = txt:lower()
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Name:lower():find(query,1,true) then
            table.insert(names, plr.Name)
        end
    end
    for i,lbl in ipairs(suggestList) do
        if names[i] then
            lbl.Text = names[i]; lbl.Visible = true
        else
            lbl.Visible = false
        end
    end
    suggestFrame.Visible = espPlayerActiveToggle() and txt ~= "" and #names > 0
end

espPlayerBox:GetPropertyChangedSignal("Text"):Connect(function()
    updateSuggestions(espPlayerBox.Text)
end)
espPlayerBox.Focused:Connect(function()
    updateSuggestions(espPlayerBox.Text)
end)
espPlayerBox.FocusLost:Connect(function()
    updateSuggestions(espPlayerBox.Text)
end)

for _,lbl in ipairs(suggestList) do
    lbl.MouseButton1Click:Connect(function()
        espSelectedName = lbl.Text
        espPlayerBox.Text = lbl.Text
        suggestFrame.Visible = false
    end)
end
espPlayerBox:GetPropertyChangedSignal("Text"):Connect(function()
    if espPlayerBox.Text ~= "" then
        suggestFrame.Visible = espPlayerActiveToggle() and true
    else
        suggestFrame.Visible = false
        espSelectedName = nil
    end
end)

--------------------------------------------------------------------------------------------
-- 4. FOV/POV Básico
local povSection = createSection(70, "FOV/POV")
local povOn = makeToggle(povSection, "FOV Circle", true, 10, 36)
local povRadiusBox = Instance.new("TextBox", povSection)
povRadiusBox.Size = UDim2.new(0,100,0,28)
povRadiusBox.Position = UDim2.new(0,120,0,36)
povRadiusBox.Text = "Radius: 100"
povRadiusBox.BackgroundColor3 = Color3.fromRGB(32,50,60)
povRadiusBox.Font = Enum.Font.Code
povRadiusBox.TextColor3 = Color3.new(1,1,1)
local povRadius = 100
povRadiusBox.FocusLost:Connect(function()
    local n = tonumber(povRadiusBox.Text:match("%d+")) or 100
    povRadius = clamp(n,40,400)
    povRadiusBox.Text = "Radius: "..povRadius
end)

--------------------------------------------------------------------------------------------
-- 5. CONTROLES/INFO
local ctrlSection = createSection(58, "Controles")
local inst = Instance.new("TextLabel", ctrlSection)
inst.Size = UDim2.new(1,-12,1,0)
inst.Position = UDim2.new(0,6,0,0)
inst.BackgroundTransparency = 1
inst.TextColor3 = Color3.new(0.9,0.9,1)
inst.Font = Enum.Font.Code
inst.TextXAlignment = Enum.TextXAlignment.Left
inst.Text = "HUB scrollável e móvel! Ative/desative cada função ESP individualmente no painel."
inst.TextScaled = true

--------------------------------------------------------------------------------------------
-- Lógica principal e desenhar ESP (implementação básica + rainbow)
local function getRainbowColor()
    local t = tick()
    return Color3.fromHSV((t % 6) / 6, 1, 1)
end

local function playerShouldESP(plr)
    if espPlayerActiveToggle() and espSelectedName then
        return plr.Name == espSelectedName
    elseif espEnemiesOnly then
        return IsEnemy(plr)
    else
        return plr ~= LocalPlayer
    end
end

local billboards, skeletonLines, tracerLines, boxAdorns = {}, {}, {}, {}

local function cleanupESP()
    for plr,v in pairs(billboards) do if v and v.Parent then v:Destroy() end end
    for plr,v in pairs(skeletonLines) do if v then for _,ln in ipairs(v) do ln.Visible = false; ln:Destroy() end end end
    for plr,v in pairs(tracerLines) do if v then v.Visible = false; v:Destroy() end end
    for plr,v in pairs(boxAdorns) do if v and v.Parent then v:Destroy() end end
    table.clear(billboards) table.clear(skeletonLines) table.clear(tracerLines) table.clear(boxAdorns)
end

local function updateESPs()
    local cam = workspace.CurrentCamera
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr == LocalPlayer or not playerShouldESP(plr) then
            if billboards[plr] then billboards[plr]:Destroy(); billboards[plr]=nil end
            if skeletonLines[plr] then for _,ln in ipairs(skeletonLines[plr]) do ln.Visible = false; ln:Destroy() end skeletonLines[plr]=nil end
            if tracerLines[plr] then tracerLines[plr].Visible = false; tracerLines[plr]:Destroy(); tracerLines[plr]=nil end
            if boxAdorns[plr] then boxAdorns[plr]:Destroy(); boxAdorns[plr]=nil end
            continue
        end

        local char = plr.Character
        if not char then continue end
        local hrp = safeFindHumanoidRootPart(char)
        if not hrp then continue end

        local rainbowColor = getRainbowColor()
        local hum = char:FindFirstChildOfClass("Humanoid")
        local hpVal = hum and hum.MaxHealth > 0 and (hum.Health / hum.MaxHealth) or 0
        -- ESP Box
        if boxEspToggle() then
            if not boxAdorns[plr] then
                local adorn = Instance.new("BoxHandleAdornment")
                adorn.Adornee = hrp
                adorn.Size = Vector3.new(4,7,2)
                adorn.Transparency = 0.5
                adorn.Color3 = rainbowEspToggle() and rainbowColor or (IsEnemy(plr) and Color3.fromRGB(255,44,54) or Color3.fromRGB(60,160,255))
                adorn.AlwaysOnTop = true
                adorn.ZIndex = 1
                adorn.Parent = hrp
                boxAdorns[plr] = adorn
            else
                boxAdorns[plr].Color3 = rainbowEspToggle() and rainbowColor or (IsEnemy(plr) and Color3.fromRGB(255,44,54) or Color3.fromRGB(60,160,255))
                boxAdorns[plr].Visible = true
            end
        elseif boxAdorns[plr] then
            boxAdorns[plr].Visible = false
        end

        -- Billboard (Name/HPBar/Weapon/Distance)
        if nameEspToggle() or hpEspToggle() or distEspToggle() or weaponEspToggle() then
            if not billboards[plr] then
                local bb = Instance.new("BillboardGui")
                bb.Name = "KnHubESP"
                bb.MaxDistance = 350
                bb.Size = UDim2.new(0,118,0,46)
                bb.Adornee = hrp
                bb.AlwaysOnTop = true
                bb.Parent = hrp
                billboards[plr] = bb
            end
            billboards[plr].Enabled = true
            local yPos = 0
            -- Name
            if nameEspToggle() then
                local nameL = billboards[plr]:FindFirstChild("Name") or Instance.new("TextLabel",billboards[plr])
                nameL.Name = "Name"
                nameL.Size = UDim2.new(1,0,0,16)
                nameL.Position = UDim2.new(0,0,0,yPos)
                nameL.Font = Enum.Font.GothamSemibold
                nameL.TextColor3 = rainbowEspToggle() and rainbowColor or (IsEnemy(plr) and Color3.fromRGB(255,44,54) or Color3.fromRGB(60,160,255))
                nameL.TextStrokeTransparency = 0.18
                nameL.Text = plr.Name
                nameL.BackgroundTransparency = 1
                nameL.TextScaled = true
                nameL.Visible = true
                yPos = yPos + 16
            end
            -- HPBar
            if hpEspToggle() then
                local bar = billboards[plr]:FindFirstChild("HPBar") or Instance.new("Frame",billboards[plr])
                bar.Name = "HPBar"
                bar.Size = UDim2.new(hpVal,0,0,8)
                bar.Position = UDim2.new(0,0,0,yPos)
                bar.BackgroundColor3 = Color3.fromRGB(30,220,90)
                bar.BorderSizePixel = 0
                bar.Visible = true
                yPos = yPos + 8
            end
            -- Distância
            if distEspToggle() then
                local dist = (cam.CFrame.Position - hrp.Position).Magnitude
                local distL = billboards[plr]:FindFirstChild("Dist") or Instance.new("TextLabel",billboards[plr])
                distL.Name = "Dist"
                distL.Size = UDim2.new(1,0,0,10)
                distL.Position = UDim2.new(0,0,0,yPos)
                distL.Text = "Dist: "..math.floor(dist)
                distL.Font = Enum.Font.Code
                distL.TextColor3 = Color3.fromRGB(100,255,255)
                distL.BackgroundTransparency = 1
                distL.TextScaled = true
                distL.Visible = true
                yPos = yPos + 10
            end
            -- Arma/item
            if weaponEspToggle() then
                local itemL = billboards[plr]:FindFirstChild("Item") or Instance.new("TextLabel",billboards[plr])
                itemL.Name = "Item"
                itemL.Size = UDim2.new(1,0,0,10)
                itemL.Position = UDim2.new(0,0,0,yPos)
                local weap = (char:FindFirstChild("Weapon") or char:FindFirstChildOfClass("Tool"))
                itemL.Text = weap and ("Arma: "..weap.Name) or ""
                itemL.Font = Enum.Font.Code
                itemL.TextColor3 = Color3.fromRGB(250,180,60)
                itemL.BackgroundTransparency = 1
                itemL.TextScaled = true
                itemL.Visible = true
                yPos = yPos + 10
            end
        elseif billboards[plr] then
            billboards[plr].Enabled = false
        end

        -- Skeleton ESP
        local DrawingAvail, DrawingObj = pcall(function() return Drawing end)
        if skeletonEspToggle() and DrawingAvail and DrawingObj then
            local skeletonPairs = {
                {"Head","UpperTorso"},{"UpperTorso","LowerTorso"},
                {"UpperTorso","LeftUpperArm"},{"LeftUpperArm","LeftLowerArm"},{"LeftLowerArm","LeftHand"},
                {"UpperTorso","RightUpperArm"},{"RightUpperArm","RightLowerArm"},{"RightLowerArm","RightHand"},
                {"LowerTorso","LeftUpperLeg"},{"LeftUpperLeg","LeftLowerLeg"},{"LeftLowerLeg","LeftFoot"},
                {"LowerTorso","RightUpperLeg"},{"RightUpperLeg","RightLowerLeg"},{"RightLowerLeg","RightFoot"}
            }
            if not skeletonLines[plr] then
                skeletonLines[plr] = {}
                for i=1,#skeletonPairs do
                    local ln = DrawingObj.new("Line")
                    ln.Thickness = 2
                    ln.Transparency = 1
                    ln.Visible = false
                    table.insert(skeletonLines[plr],ln)
                end
            end
            for i,pair in ipairs(skeletonPairs) do
                local a, b = pair[1], pair[2]
                local p1 = char:FindFirstChild(a)
                local p2 = char:FindFirstChild(b)
                local ln = skeletonLines[plr][i]
                if p1 and p2 and ln then
                    local v1,v1on = cam:WorldToViewportPoint(p1.Position)
                    local v2,v2on = cam:WorldToViewportPoint(p2.Position)
                    ln.From = Vector2.new(v1.X,v1.Y)
                    ln.To = Vector2.new(v2.X,v2.Y)
                    ln.Visible = v1on and v2on
                    ln.Color = rainbowEspToggle() and rainbowColor or (IsEnemy(plr) and Color3.fromRGB(255,40,60) or Color3.fromRGB(60,160,255))
                else
                    if ln then ln.Visible = false end
                end
            end
        elseif skeletonLines[plr] then
            for _,ln in ipairs(skeletonLines[plr]) do ln.Visible = false end
        end

        -- Tracer ESP 
        if tracerEspToggle() and DrawingAvail and DrawingObj then
            if not tracerLines[plr] then
                local tl = DrawingObj.new("Line")
                tl.Thickness = 2
                tl.Transparency = 1
                tracerLines[plr] = tl
            end
            local v,onScreen = cam:WorldToViewportPoint(hrp.Position)
            local scrX,scrY = cam.ViewportSize.X, cam.ViewportSize.Y
            local tracerEnd = Vector2.new(v.X,v.Y)
            local tracerStart = Vector2.new(scrX/2,scrY)
            tracerLines[plr].From = tracerStart
            tracerLines[plr].To = tracerEnd
            tracerLines[plr].Visible = onScreen
            tracerLines[plr].Color = rainbowEspToggle() and rainbowColor or (IsEnemy(plr) and Color3.fromRGB(255,44,54) or Color3.fromRGB(60,160,255))
        elseif tracerLines[plr] then
            tracerLines[plr].Visible = false
        end
    end
end

--------------------------------------------------------------------------------------------
-- POV CIRCLE
local povVisual = nil
local function updatePOVCircle()
    if povVisual then povVisual:Destroy() povVisual=nil end
    if not povOn() then return end
    local cam = workspace.CurrentCamera
    local rad = povRadius
    local ctrX = math.floor(cam.ViewportSize.X/2)
    local ctrY = math.floor(cam.ViewportSize.Y/2)
    local circ = Instance.new("Frame", gui)
    circ.Size = UDim2.new(0,rad*2,0,rad*2)
    circ.Position = UDim2.new(0,ctrX-rad,0,ctrY-rad)
    circ.BackgroundTransparency = 1
    circ.BorderSizePixel = 0
    circ.ZIndex = 25
    local img = Instance.new("ImageLabel", circ)
    img.Size = UDim2.new(1,0,1,0)
    img.BackgroundTransparency = 1
    img.Image = "rbxassetid://3570695787"
    img.ImageColor3 = Color3.fromRGB(90,120,220)
    img.ImageTransparency = 0.45
    povVisual = circ
end

--------------------------------------------------------------------------------------------
-- AIMBOT LOGIC com check de parede
local function getClosestTarget(fovRad, fovCenter, enemiesOnly)
    local cam = workspace.CurrentCamera
    local closest, closestDist = nil, fovRad
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr == LocalPlayer then continue end
        if enemiesOnly and not IsEnemy(plr) then continue end
        local char = plr.Character
        if not char then continue end
        local hrp = safeFindHumanoidRootPart(char)
        local hum = char:FindFirstChildOfClass("Humanoid")
        if not hrp or not hum or hum.Health<=0 then continue end
        local vec, onScreen = cam:WorldToViewportPoint(hrp.Position)
        if not onScreen then continue end
        if not isVisible(cam.CFrame.Position, hrp.Position) then continue end
        local dist = (Vector2.new(vec.X,vec.Y)-fovCenter).Magnitude
        if dist < closestDist then closest, closestDist = plr, dist end
    end
    return closest
end
local function handleAimbot()
    if not aimbotOn() then return end
    local cam = workspace.CurrentCamera
    local fov = aimFOV
    local pullAmt = pull
    local enemiesOnly = aimEnemiesOnly
    local ctr = Vector2.new(cam.ViewportSize.X/2, cam.ViewportSize.Y/2)
    local target = nil
    if aimLockedPlayer and aimLockedPlayer.Parent and aimLockedPlayer.Character then
        local hrp = safeFindHumanoidRootPart(aimLockedPlayer.Character)
        local hum = aimLockedPlayer.Character:FindFirstChildOfClass("Humanoid")
        if hrp and hum and hum.Health > 0 and isVisible(cam.CFrame.Position, hrp.Position) then
            target = aimLockedPlayer
        else
            aimLockedPlayer = nil
            aimUnlockBtn.Visible = false
            aimLockBtn.Text = "Travar Mira"
            aimLockBtn.BackgroundColor3 = Color3.fromRGB(33,110,220)
        end
    end
    if not target then
        target = getClosestTarget(fov, ctr, enemiesOnly)
    end
    if target and target.Character then
        local hrp = safeFindHumanoidRootPart(target.Character)
        pcall(function()
            if hrp then
                local destCFrame = CFrame.new(cam.CFrame.Position, hrp.Position)
                cam.CFrame = cam.CFrame:Lerp(destCFrame, clamp(pullAmt/100,0.10, 1))
            end
        end)
    end
end

--------------------------------------------------------------------------------------------

-- Limpador (ao sair jogador)
Players.PlayerRemoving:Connect(function(plr)
    if billboards[plr] then billboards[plr]:Destroy(); billboards[plr]=nil end
    if skeletonLines[plr] then for _,ln in ipairs(skeletonLines[plr]) do ln.Visible = false; ln:Destroy() end skeletonLines[plr]=nil end
    if tracerLines[plr] then tracerLines[plr].Visible=false; tracerLines[plr]:Destroy(); tracerLines[plr]=nil end
    if boxAdorns[plr] then boxAdorns[plr]:Destroy(); boxAdorns[plr]=nil end
    if plr == aimLockedPlayer then
        aimLockedPlayer = nil
        aimUnlockBtn.Visible = false
        aimLockBtn.Text = "Travar Mira"
        aimLockBtn.BackgroundColor3 = Color3.fromRGB(33,110,220)
    end
end)

--------------------------------------------------------------------------------------------
-- MAIN LOOP
local lastPOVUpdate = 0
RunService.RenderStepped:Connect(function()
    pcall(updateESPs)
    if aimbotOn() then pcall(handleAimbot) end
    if povOn() then
        if tick()-lastPOVUpdate > 0.03 then
            pcall(updatePOVCircle)
            lastPOVUpdate = tick()
        end
    elseif povVisual and povVisual.Parent then povVisual:Destroy(); povVisual=nil end
end)

--[[
    KnHub CG Avançado!
    Todas funções ESP separadas, painéis organizados, rolagem e drag habilitados.
    Adicione funções extras no mesmo formato se quiser!
]]